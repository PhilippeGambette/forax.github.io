<!DOCTYPE html>
<html>
  <head>
    <meta charset='UTF-8'>
    <meta name='viewport' content='width=device-width'>
    <title>Remi Forax's Blog</title>
    <link rel='stylesheet' id='twentythirteen-style-css'  href='style.css' type='text/css' media='all' />
    <style type='text/css' id='twentythirteen-header-css'>
    .site-header {
      background: url(circle.png) no-repeat scroll top;
      background-size: 1600px auto;
    }
    </style>
    <!-- link type='text/css' rel='stylesheet' href='styles/shCoreDefault.css'/ -->
  </head>
  <body class='home blog single-author'>
    <div id='page' class='hfeed site'>
      <header id='masthead' class='site-header' role='banner'>
        <a class='home-link' href='index.html' title='forax's blog' rel='home'>
          <h1 class='site-title'>Remi Forax's Blog</h1>
          <h2 class='site-description'>Java, the JVM and stuff around</h2>
        </a>
      </header>
      <div id='main' class='site-main'>
        <div id='primary' class='content-area'>
          <div id='content' class='site-content' role='main'>
<article id='post' class='post type-post status-publish format-standard hentry category-uncategorized'>
<header class='entry-header'>
  <h1 class='entry-title'>
    <a href='2014-05-11-48b51fb2924c7773e159-optional_or_not.html' title='Permalink' rel='bookmark'>
optional or not
     </a>
  </h1>
  <div class='entry-meta'>
    <span class='date'>
      <time class='entry-date'>
Sunday, May 11, 2014
      </time>
    </span>
    <span class='categories-links'>
java
    </span>
  </div><!-- .entry-meta -->
</header><!-- .entry-header -->
<div class='entry-content'>
 <p>
<p>Java 8 among other things introduces the class Optional (and its siblings OptionalInt, OptionalLong and OptionalDouble), this blog post tries to explain why we have introduced such classes and how to use it.</p><p><a href="http://docs.oracle.com/javase/8/docs/api/java/util/Optional.html">Optional</a> had been introduced in the Java API to deal with the case where the result of a calculation can exist or not.</p><p>Here is an example, let suppose I have an object that record the duration of a call to a service, the service is called multiple times and for each call, the object record the time spent in the service. Moreover, this object keeps several values to be able compute the average time spent in the service.</p>
<pre><code>public class TimeStat {
  private long totalTime;
  private long recordCount;

  public void record(long elapsedTime) {
    totalTime += elapsedTime;
    recordCount++;
  }

  public double getAverageTime() {
    return ((double)totalTime) / recordCount;
  }
}
</code></pre><p>Now, let suppose we also want to keep the minimum time spent in the service. In term of API, it's a little more complex because if no time is recorded, there is no minimum, so getMinimumTime() can not just return a long integer.</p>
<pre><code>public class TimeStat {
  public long getMinimumTime() {
    return ...
  }
}
</code></pre><p>The return type of getMinimumTime() should represent either a long integer value or no value. This is exactly what <a href="http://docs.oracle.com/javase/8/docs/api/java/util/OptionalLong.html">java.util.OptionalLong</a> is. OptionalLong has two factory methods, <a href="http://docs.oracle.com/javase/8/docs/api/java/util/OptionalLong.html#empty--">empty()</a> that creates an OptionalLong whith no value and <a href="http://docs.oracle.com/javase/8/docs/api/java/util/OptionalLong.html#of-long-">of()</a> that creates an OptionalLong with a value.<br/>So the code of TimeStat is</p>
<pre><code>public class TimeStat {
  private long totalTime;
  private long recordCount;
  private long minimumTime;

  public void record(long elapsedTime) {
    totalTime += elapsedTime;
    minimumTime = (recordCount == 0)? elapsedTime:
                                      Math.min(minimumTime, elapsedTime);
    recordCount++;
  }

  public OptionalLong getMinimumTime() {
    if (recordCount == 0) {
      return OptionalLong.empty();
    }
    return OptionalLong.of(minimumTime);
  }
}
</code></pre><p>Note that before Java 8, instead of OptionalLong, one can use java.lang.Long with the convention that null encode no value.<br/>In that case, the code of getMinimum() will be</p>
<pre><code>  public Long getMinimumTime() {
    if (recordCount == 0) {
      return null;
    }
    return Long.valueOf(minimumTime);
  }
</code></pre><p>The problem with that code is that you have to document that null means no value (even if it's the traditional meaning, it has to be documented) and worst because nobody read the doc, users of the class TimeStat will forget that getMinimum() can return null and their code will throw a NullPointerException.</p><p>So compared to java.lang.Long, java.util.OptionalLong make the contract more explicit and avoid NullPointerException in the client code. We will see later that there is also an important difference in the way of OptionalLong is specified.</p><p>Note that creating an OptionalLong is a form of boxing so one may think that there is cost to use the Optional abstraction.<br/>This is not true <em>in this example</em> because the VM is able to remove the creation of OptionalLong. If getMinimum() is not too big, the VM will take the code of getMinimum() and merge it with the code that calls getMinimum(), an operation known as inlining, by doing that the code that create the OptionalLong and the code that use it will be part of the same bundle and so the VM will see that the allocation of an OptionalLong instance is not needed.</p><p>This is really great because API designers can use Optional to explicit the contract of getMinimum() and users will not pay the cost of the abstraction.</p><p>But this is not always the case ...</p><h3>Storing Optional in a field ?</h3><p>Let now suppose that i want to design a class corresponding to a report with an optional header.<br/>One can come with that code</p>
<pre><code>public class Report {
  private final Optional&lt;String&gt; header;

  public Report(Optional&lt;String&gt; header) {
    this.header = header;
  }
  
  public Optional&lt;String&gt; getHeader() {
    return header;
  }
}
</code></pre><p>while it's a valid code, this code pay the price of using OptionalLong as an abstraction. In fact, storing an Optional into a field introduce two supplementary costs:<br/> - A cost in term of memory, Optional is an object, at least for now, so the code will allocate an Optional object (an object header + the size of the two fields, with a heap &lt; 32G it's 16 bytes)<br/> - A cost at runtime, each time a code will access to the field header to get the string value, it will cost a supplementary indirection. And this indirection is not cheap because the reference to a Report and the reference to Optional may not be in the same cache line so accessing to the string inside may result in a cache miss.</p><p>There is a way to mitigate those costs and keep the Optional abstraction. Optional is great for the user that want to use the API, but it can be seen as not necessary inside the object. So inside the object, the header can be null and outside the object it can be represented by Optional.</p>
<pre><code>public class Report {
  private final /* may be null */ String header;

  public Report(Optional&lt;String&gt; header) {
    this.header = header.orElse(null);
  }
  
  public Optional&lt;String&gt; getHeader() {
    return Optional.ofNullable(header);
  }
}
</code></pre><p>With this code, Optional instances are kept on the stack where we know that the VM will optimize them away avoiding the cost of objects creation and because Optional is not stored in a field, we can expect no supplementary cost.</p><h3>Can the supplementary costs of storing an Optional in a field vanish ?</h3><p>yes and no. Currently, with Java 8, the answer is no.<br/>In the future, let say with Java 9, the anwser may be yes :)</p><p>The idea is that the VM can take the fields of Optional and store then with the fields of the class Report, something which is called co-location. The memory cost will be a little higher (a supplementary field) but no supplementary indirection.</p><p>This is not possible to do that with plain Java objects because a Java object by default has an identity and when you store the fields of Optional inside Report, the instance of Optional disapear, so its identity is lost (note that its class is also lost but java.util.Optional has no subclass unlike Option in Scala).</p><p>What we want to do for Java 9, is to add a way to specify that an object has no identity, something which is commonly referenced<br/>as a <a href="https://en.wikipedia.org/wiki/Value_object">value object</a>. For this kind of object, the VM will be free to flatten all the fields of a value object inside an enclosing object.</p><p>There is already a <a href="http://cr.openjdk.java.net/~jrose/values/values-0.html">strawman proposal of the value object semantics</a> for Java 9.</p><h3>Conclusion</h3><p>And to finish, you should never forget that even if you use Optional, having something that can have no value is not free because it makes the user code less simple to write. It's far better to avoid to return either Optional or null, by example, for the class Report, instead of having no value the header can be empty (the String ""). Using <a href="http://docs.oracle.com/javase/7/docs/api/java/util/Objects.html">Objects.requireNonNull()</a> in the constructor, will guarantee that the value returned by getHeader() always exist simplifying all codes that use the class Report.</p>
<pre><code>public class Report {
  private final String header;   // may be empty but not null

  public Report(String header) {
    this.header = Objects.requireNonNull(header);
  }
  
  public String getHeader() {
    return header
  }
}
</code></pre><p>cheers,<br/>RÃ©mi</p>
 </p>
</div><!-- .entry-content -->
<footer class='entry-meta'>
   <div class='comments-link'>
<a href='https://gist.github.com/forax/48b51fb2924c7773e159' title='Comments'>Write a comment</a>
   </div><!-- .comments-link -->
   <span id='comments'/>
</footer><!-- .entry-meta -->
</article><!-- #post -->
<script type='text/javascript' src='assets/markdown.min.js'></script>
<script type='text/javascript' src='assets/ajax.js'></script>
<script type='text/javascript'>fetchComments(48b51fb2924c7773e159);</script>
          </div><!-- #content -->
        </div><!-- #primary -->
      </div><!-- #main -->
    </div><!-- #page -->
    <footer id='colophon' class='site-footer' role='contentinfo'>
      <div id='secondary' class='sidebar-container' role='complementary'>
        <div class='widget-area'>
          <aside class='widget widget_recent_entries'>
            <img alt='Creative Commons License' src='cc128.png' width='64' height='64'/>
          </aside>
          <aside id='rss' class='widget widget_recent_entries'>
            <a href='rss.xml'><img src='cake-rss.png' width='64' height='64' alt='RSS Feed'/></a>
          </aside>
          <!-- aside class='widget widget_recent_entries'>
            Generated by <a href='https://github.com/forax/blog' src='cc128.png' alt='blog'/>Blog</a>
          </aside -->
        </div>
      </div><!-- #secondary -->
    </footer><!-- #colophon -->
    <!-- script type='text/javascript' src='scripts/shCore.js'></script>
    <script type='text/javascript' src='scripts/shBrushJScript.js'></script>
    <script type='text/javascript'>SyntaxHighlighter.all();</script -->
  </body>
</html>
